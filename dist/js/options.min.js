var app = angular.module('OpenTabs', ['ngRoute', 'ngAnimate', 'ngAria', 'ngMaterial', 'angular-google-analytics']);

app.config(['$routeProvider', '$compileProvider', '$mdIconProvider', '$mdThemingProvider', 'AnalyticsProvider', function ($routeProvider, $compileProvider, $mdIconProvider, $mdThemingProvider, AnalyticsProvider) {

    // Allow "chrome-extension" protocol
    $compileProvider.aHrefSanitizationWhitelist(/^\s*(https?|chrome-extension|blob:chrome-extension|file|blob):/);
    $compileProvider.imgSrcSanitizationWhitelist(/^\s*(https?|chrome-extension|file|blob):|data:image\//);

    // Load icons list by name
    $mdIconProvider
        .icon('arrow-right', '/icons/arrow-right.svg')
        .icon('close', '/icons/close.svg')
        .icon('content-duplicate', '/icons/content-duplicate.svg')
        .icon('credit-card', '/icons/credit-card.svg')
        .icon('dots-horizontal', '/icons/dots-horizontal.svg')
        .icon('dots-vertical', '/icons/dots-vertical.svg')
        .icon('github-circle', '/icons/github-circle.svg')
        .icon('google-chrome', '/icons/google-chrome.svg')
        .icon('magnify', '/icons/magnify.svg')
        .icon('pin', '/icons/pin.svg')
        .icon('pin-off', '/icons/pin-off.svg')
        .icon('refresh', '/icons/refresh.svg')
        .icon('reload', '/icons/reload.svg')
        .icon('save', '/icons/content-save.svg')
        .icon('settings', '/icons/settings.svg');

    $mdThemingProvider
        .theme('default')
        .primaryPalette('blue', {
            default: '600'
        })
        .accentPalette('yellow', {
            default: '700'
        })
        .warnPalette('red', {
            default: 'A700'
        });

    // Analytics config
    AnalyticsProvider.setAccount('UA-27524593-8');
    AnalyticsProvider.setHybridMobileSupport(true);
    AnalyticsProvider.setDomainName('none');

    var routes = {
        '/:event?/:version?': {
            templateUrl: '/html/home.min.html',
            controller: 'HomeController'
        }
    };

    for (var path in routes) {
        if (routes.hasOwnProperty(path)) {
            $routeProvider.when(path, routes[path]);
        }
    }

}]);

app.run(['Analytics', function (Analytics) {

}]);

app.filter('searchFilter', function () {
    return function (items, query) {
        if (query === null || query === '') {
            return items;
        }

        query = query.toLowerCase();

        var filtered = [];

        angular.forEach(items, function (item) {
            if (item.title.toLowerCase().indexOf(query) !== -1 || item.url.toLowerCase().indexOf(query) !== -1) {
                filtered.push(item);
            }
        });

        return filtered;
    };
});

app.controller('HomeController', ['$scope', '$routeParams', '$location', '$mdDialog', '$mdToast', 'Analytics', function ($scope, $routeParams, $location, $mdDialog, $mdToast, Analytics) {

    // ---------------------------------------------------------------------------------
    // Actions

    $scope.closeAllTabs = function (tabs, evt) {
        if (tabs.code === 'PINNED_TABS') {
            var confirm = $mdDialog
                .confirm()
                .clickOutsideToClose(false)
                .title('Close all')
                .textContent('Do you really want to close all pinned tabs?')
                .ariaLabel('Close all')
                .targetEvent(evt)
                .ok('Close all')
                .cancel('Cancel');

            $mdDialog.show(confirm).then(function () {
                $scope.removeAllTabs(tabs);
            });
        } else {
            $scope.removeAllTabs(tabs);
        }
    };

    $scope.removeAllTabs = function (tabs) {
        var ids = [];

        angular.forEach(tabs.data, function (tab) {
            ids.push(tab.id);
        });

        chrome.tabs.remove(ids);
    };

    $scope.goToTab = function (tab) {
        chrome.tabs.update(tab.id, { active: true, highlighted: true });
    };

    $scope.removeTab = function (tab) {
        chrome.tabs.remove(tab.id);
    };

    $scope.reloadTab = function (tab) {
        chrome.tabs.reload(tab.id);
    };

    $scope.duplicateTab = function (tab) {
        chrome.tabs.create({ url: tab.url, active: false, pinned: tab.pinned, index: tab.index + 1 });
    };

    $scope.pinOrUnpinTab = function (tab, pinned) {
        chrome.tabs.update(tab.id, { pinned: pinned });
    };

    // --------------------------------------------------------------------------------------------------------
    // Events

    // New install
    if ($routeParams.event === 'install') {
        var alert = $mdDialog
            .alert()
            .clickOutsideToClose(true)
            .title('Greetings')
            .textContent('Hello, thank you for installing Open Tabs!')
            .ariaLabel('Greetings')
            .targetEvent()
            .ok('Ok');

        $mdDialog.show(alert).then(function () {
            Analytics.trackEvent('greetings-dialog', 'close');

            $location.path('/');
        }, function () {
            Analytics.trackEvent('greetings-dialog', 'show-form');

            $location.path('/');
        });
    }

    // New version
    if ($routeParams.event === 'update' && $routeParams.version !== undefined) {
        $mdToast.show({
            hideDelay: 0,
            position: 'top right',
            controller: 'ToastNewVersionController',
            templateUrl: '../html/toast_new_version.min.html',
            locals: {
                version: $routeParams.version
            }
        });
    }

}]);

app.controller('ToastNewVersionController', ['$scope', '$location', '$mdToast', 'version', function ($scope, $location, $mdToast, version) {
    $scope.version = version;

    $scope.closeToast = function () {
        $mdToast.hide().then(function () {
            $location.path('/');
        });
    };

    $scope.openGitHubReleases = function () {
        chrome.tabs.create({ url: 'https://github.com/sylouuu/chrome-open-tabs/releases' });

        $scope.closeToast();
    };
}]);

app.controller('MainController', ['$scope', '$mdDialog', '$mdMedia', 'Analytics', function ($scope, $mdDialog, $mdMedia, Analytics) {

    $scope.open_tabs = {
        settings: {
            enable_new_version_notification: false,
            show_browser_action_count: true
        }
    };
    $scope.search    = { query: null };
    $scope.tabs      = {
        pinned: { code: 'PINNED_TABS', title: 'Pinned tabs', data: [] },
        standard: { code: 'STANDARD_TABS', title: 'Standard tabs', data: [] }
    };

    chrome.storage.local.get('open_tabs', function (items) {
        if (items.open_tabs !== undefined) {
            $scope.open_tabs = items.open_tabs;
        }

        $scope.$apply();
    });

    $scope.saveSettings = function (open_tabs) {
        chrome.storage.local.set({ open_tabs: open_tabs });

        chrome.extension.getBackgroundPage().handleBrowserActionBadgeEvents();
    };

    $scope.loadTabs = function () {
        chrome.tabs.query({}, function (tabs) {
            $scope.tabs.pinned.data   = [];
            $scope.tabs.standard.data = [];

            for (var i = 0; i < tabs.length; i++) {
                // Exclude options page
                if (tabs[i].url !== chrome.extension.getURL('html/options.min.html')) {
                    if (tabs[i].pinned === true) {
                        $scope.tabs.pinned.data.push(tabs[i]);
                    } else {
                        $scope.tabs.standard.data.push(tabs[i]);
                    }
                }
            }

            $scope.$apply();
        });
    };

    $scope.loadTabs();

    $scope.showSettings = function (evt) {
        $mdDialog.show({
            controller: 'SettingsModalController',
            templateUrl: '../html/settings_modal.min.html',
            targetEvent: evt,
            clickOutsideToClose: false,
            fullscreen: $mdMedia('xs'),
            resolve: {
                open_tabs: function () {
                    return $scope.open_tabs;
                }
            }
        }).then(function (data) {
            $scope.saveSettings(data);

            Analytics.trackEvent('settings', 'save');
        });
    };

    // ---------------------------------------------------------------------------------
    // Listeners

    chrome.tabs.onCreated.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onUpdated.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onRemoved.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onReplaced.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onMoved.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onDetached.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onAttached.addListener(function () {
        $scope.loadTabs();
    });

    chrome.tabs.onActivated.addListener(function () {
        $scope.loadTabs();
    });

}]);

app.controller('SettingsModalController', ['$scope', '$mdDialog', 'open_tabs', function ($scope, $mdDialog, open_tabs) {

    $scope.open_tabs = open_tabs;

    $scope.closeForm = function () {
        $mdDialog.cancel();
    };

    $scope.save = function (data) {
        $mdDialog.hide(data);
    };

}]);
